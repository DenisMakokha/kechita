name: CI/CD Deploy to Production

on:
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Build & verify the client (frontend)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  client-check:
    name: Client Build & TypeCheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: client/package-lock.json

      - run: npm ci
      - run: npx tsc --noEmit
      - run: npm run build

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Build & verify the server (backend)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  server-check:
    name: Server Build & TypeCheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: server/package-lock.json

      - run: npm ci
      - run: npx tsc --noEmit
      - run: npx nest build

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Deploy to production (only if both pass)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [client-check, server-check]
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."

            cd /opt/kechita

            # Preserve server .env, reset everything else, pull
            echo "ğŸ“¥ Pulling latest code..."
            git reset --hard HEAD
            git clean -fd -e server/.env
            git pull origin main

            # â”€â”€ Server â”€â”€
            echo "ğŸ“¦ Installing server dependencies..."
            cd /opt/kechita/server
            npm ci

            echo "ğŸ”¨ Building server..."
            npx nest build

            # Run migrations (if any exist)
            echo "ğŸ—„ï¸ Running migrations..."
            if [ -d "src/migrations" ] && [ "$(ls -A src/migrations 2>/dev/null)" ]; then
              npx typeorm migration:run -d dist/data-source.js || echo "âš ï¸ Migration runner not configured, skipping..."
            else
              echo "â„¹ï¸ No migrations found, skipping..."
            fi

            # Run production seed (idempotent â€” skips existing data)
            echo "ğŸŒ± Running production seed..."
            npx ts-node src/seeds/seed-production-defaults.ts || echo "âš ï¸ Seed completed with warnings"

            # Prune dev dependencies for production
            npm prune --omit=dev

            # Restart server
            echo "â™»ï¸ Restarting server..."
            pm2 restart kechita-api
            sleep 5

            # â”€â”€ Client â”€â”€
            echo "ğŸ“¦ Installing client dependencies..."
            cd /opt/kechita/client
            npm ci
            echo "ğŸ”¨ Building client..."
            npm run build

            # â”€â”€ Verify â”€â”€
            echo "âœ… Verifying deployment..."
            curl -sf http://localhost:3000/ > /dev/null && echo "âœ… API is healthy" || echo "âŒ API health check failed"
            pm2 save

            echo "ğŸ‰ Deployment complete!"
